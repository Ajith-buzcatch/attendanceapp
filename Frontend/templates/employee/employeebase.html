{% load static %}
{% load custom_tags %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUZ@BOOK</title>
    <link rel="stylesheet" href="{% static "employee/css/footer.css" %}">
    <link rel="stylesheet" href="{% static "employee/css/commonstyle.css" %}">
    <link rel="stylesheet" href="{% static "employee/css/landing.css" %}">
    <link rel="stylesheet" href="{% static "employee/css/leave.css" %}">
    <link rel="stylesheet" href="{% static "employee/css/personal.css" %}">
    {% comment %} <link rel="stylesheet" href="{% static 'employee/css/project.css' %}"> {% endcomment %}
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Ionicons -->
    <link href="https://cdn.jsdelivr.net/npm/ionicons@5.5.2/dist/ionicons/ionicons.min.css" rel="stylesheet">
    {% comment %} <script>
        if (!document.referrer.includes(window.location.origin) && !{{ user.is_authenticated|yesno:"true,false" }}) {
            window.location.href = "{% url 'employee_login' %}";
        }
    </script> {% endcomment %}
    {% if not user.is_authenticated %}
    <script type="text/javascript">
        window.location.href = "{% url 'employee_login' %}";
    </script>
    {% endif %}
    {% block landingcss %}
    
    {% endblock  %}
    {% block profilecss %}
    
    {% endblock  %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .data-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .break-buttons {
            background-color: white;
            padding: 10px; /* Optional: Adjust padding as needed */
        }
        
        #break-buttons {
            display: flex;
            justify-content: space-around;
            width: 100%;
            background-color:none: !important
        }
        
        #break-buttons button {
            flex: 1;
            margin: 5px;
            padding: 10px;
            background-color: #3498DB;
            color: white;
            border: none;
            cursor: pointer;
        }

        .checkout-color{
            background-color: red !important ;
        }
        
        #break-buttons button ion-icon {
            margin-right: 5px;
        }
        
        #break-buttons button:hover {
            background-color: #2980B9;
        }
    </style>
    
</head>

<body>
    <div class="landing-top">
        <div class="landing-top-details">
            
            <div class="details" >
                <a href="{% url 'employee_index' %}"><img src="{% static 'employee\images\buz@book.png' %}" alt=""></a>

            </div>
            <div class="details-left">
                {% if employee %}
                    <div class="user">
                        <p class="bold name_bottom">{{ employee.first_name }} {{ employee.last_name }}</p>
                        <p class="grey user-position">
                            {% for emp_designation in employee.designations %}
                                {{ emp_designation.designation.designation }}
                            {% endfor %}
                        </p>
                    </div>
                    <div class="dropdown ">
                        <button class="  dropdown-toggle" type="button" id="userDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="background: none;border: none;">
                            {% if employee.image_url %}
                            <img src="{{ employee.image_url }}" alt="Profile Picture">
                            {% endif %}
                        </button>
                        <div class="dropdown-menu" aria-labelledby="userDropdown">
                            <a class="dropdown-item" href="{% url 'employee_profile' %}">My Profile</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="{% url "employee_logout" %}">Logout</a>
                        </div>
                    </div>
                   
                {% else %}
                    <p>No employee information available.</p>
                {% endif %}
            </div>
        
        </div>
    </div>
    
    {% block content %}
    
    {% endblock  %}

    <div class="landing-bottom">
        <div class="navigation">
            <ul>
                <li class="list {% active request 'employee_index' %}">
                    <a href="{% url "employee_index" %}">
                        <span class="icon">
                            <ion-icon name="home-outline"></ion-icon>
                        </span>
                        <span class="text">Home</span>
                    </a>
                </li>
                <li class="list {% active request 'leave' %}">
                    <a href="{% url 'leave' %}">
                        <span class="icon">
                            <ion-icon name="briefcase-outline"></ion-icon>
                        </span>
                        <span class="text">Leave</span>
                    </a>
                </li>
                <li class="list {% active request 'leave_form' %}">
                    <a href="{% url 'leave_form' %}">
                        <span class="icon ">
                            <ion-icon name="add-outline"></ion-icon>
                        </span>
                    </a>
                </li>
                <li class="list {% active request 'reports' %}">
                    <a href="{% url 'reports' %}">
                        <span class="icon">
                            <ion-icon name="document-text-outline"></ion-icon>
                        </span>
                        <span class="text">Report</span>
                    </a>
                </li>
                <li class="list {% active request 'employee_profile' %}">
                    <a href="{% url "employee_profile" %}">
                        <span class="icon">
                            <ion-icon name="person-outline"></ion-icon>
                        </span>
                        <span class="text">Profile</span>
                    </a>
                </li>
                {% comment %} <li class="list">
                    <form action="{% url 'employee_logout' %}" method="post">
                        {% csrf_token %}
                        <!-- Assuming you want a button for logout -->
                            <span class="icon">
                                <ion-icon name="log-out-outline"></ion-icon>
                            </span>
                            <span class="text">Logout</span>
                        
                    </form> 
                    <a href="{% url 'employee_logout' %}">
                        <span class="icon">
                            <ion-icon name="log-out-outline"></ion-icon>
                        </span>
                        
                    </a>
                </li> {% endcomment %}
                <div class="indicator"></div>
            </ul>
        </div>
    </div>
    <div class="fab-wrapper">
        <input id="fabCheckbox" type="checkbox" class="fab-checkbox" />
        <label class="fab" for="fabCheckbox">
            <span class="fab-dots fab-dots-1"></span>
            <span class="fab-dots fab-dots-2"></span>
            <span class="fab-dots fab-dots-3"></span>
        </label>
        <div class="fab-wheel">
            <a class="fab-action fab-action-1" href="{% url 'employee_index' %}">
                <ion-icon name="home-outline"></ion-icon>
            </a>
            <a class="fab-action fab-action-2" href="{% url 'leave' %}">
                <ion-icon name="list-outline"></ion-icon>
            </a>
            <a class="fab-action fab-action-3" href="{% url 'reports' %}">
                <ion-icon name="apps-outline"></ion-icon>
            </a>
            <a class="fab-action fab-action-4" href="{% url 'employee_profile' %}">
                <ion-icon name="person-outline"></ion-icon>
            </a>
            <a class="fab-action fab-action-5" href="{% url 'leave_form' %}">
                <ion-icon name="add-outline"></ion-icon>
            </a>
        </div>
    </div>

    {% block profilejs %}

    {% endblock %}

    {% block landingjs %}

    {% endblock %}

    {% block leaveformjs %}

    {% endblock %}
   
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Include Popper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <!-- Include Bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <!-- Add this inside your landing.html -->
    
    <script>
        let countdownInterval;
        let totalSeconds;
        let breakSeconds = 0;
        let breakStart = null;
        
        function startCountdown() {
            countdownInterval = setInterval(function() {
                if (totalSeconds <= 0) {
                    clearInterval(countdownInterval);
                    return;
                }
                totalSeconds--;
        
                let hours = Math.floor(totalSeconds / 3600);
                let minutes = Math.floor((totalSeconds % 3600) / 60);
                let seconds = totalSeconds % 60;
        
                document.getElementById('hours').textContent = String(hours).padStart(2, '0');
                document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
                document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
        
                localStorage.setItem('totalSeconds', totalSeconds);
                localStorage.setItem('startTime', Date.now());
            }, 1000);
        }
        
        function stopCountdown() {
            clearInterval(countdownInterval);
            totalSeconds = 9 * 60 * 60; // Reset to 9 hours
            document.getElementById('hours').textContent = '09';
            document.getElementById('minutes').textContent = '00';
            document.getElementById('seconds').textContent = '00';
            localStorage.removeItem('totalSeconds');
            localStorage.removeItem('startTime');
            localStorage.removeItem('breakSeconds');
        }
        
         function clearLocalStorage() {
            localStorage.removeItem('totalSeconds');
            localStorage.removeItem('startTime');
            localStorage.removeItem('breakSeconds');
            localStorage.removeItem('breakStart');
            localStorage.removeItem('breakActive');
            localStorage.removeItem('currentBreakType');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            resumeCountdown();
        
            const isNewUser = {{ is_new_user|yesno:"true,false" }};
            console.log('Is new user:', isNewUser);
        
            if (isNewUser) {
                
                document.getElementById('checkin-button').style.display = 'block';
                document.getElementById('break-buttons').style.display = 'none';
                
            }
        });
        
        function handleCheckIn() {
            getLocationAndSubmit('checkin', 'attendance-form', function(success) {
                if (success) {
                    totalSeconds = 9 * 60 * 60; // 9 hours in seconds
                    saveCountdownState();
                    startCountdown();
                    
                    document.getElementById('checkin-button').style.display = 'none';
                    document.getElementById('break-buttons').style.display = 'flex';
                    document.getElementById('break-hours').style.display = 'block';
                    
                }
            });
        }

        function showCheckoutAndBreakButtons() {
            document.getElementById('checkin-button').style.display = 'none';
            document.getElementById('checkout-button').style.display = 'block';
            document.getElementById('break-buttons').style.display = 'flex';
            document.getElementById('break-hours').style.display = 'block';
        }
        
        function getLocationAndSubmit(action, formId, callback) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var latitude = position.coords.latitude;
                    var longitude = position.coords.longitude;
                    
                    document.querySelectorAll('input[name="latitude"]').forEach(function(input) {
                        input.value = latitude;
                    });
                    document.querySelectorAll('input[name="longitude"]').forEach(function(input) {
                        input.value = longitude;
                    });
                    
                    document.querySelector(`#${formId} input[name="action"]`).value = action;
                    document.getElementById(formId).submit();
                    
                    if (callback) {
                        callback(true);
                    }
                }, function(error) {
                    if (error.code === error.PERMISSION_DENIED) {
                        alert('Please Enable Location');
                    } else {
                        alert('Error fetching location: ' + error.message);
                    }
                    
                    if (callback) {
                        callback(false);
                    }
                });
            } else {
                alert('Geolocation is not supported by this browser.');
                
                if (callback) {
                    callback(false);
                }
            }
        }
        

        // document.addEventListener('DOMContentLoaded', resumeCountdown);


        function validateForgotCheckinForm() {
            var startTime = document.getElementById('start-time').value;
            var reason = document.getElementById('reason').value;
    
            if (!startTime || !reason) {
                alert('Please fill out all required fields.');
                return false;
            }
            return true;
        }
        
        function submitForgotCheckin() {
            if (validateForgotCheckinForm()) {
                getLocationAndSubmit('forgot_checkin', 'forgot-checkin-form');

                // Start the countdown after submitting forgot check-in
                totalSeconds = 9 * 60 * 60; // 9 hours in seconds
                saveCountdownState();
                startCountdown();
                toggleButtons(true);
            }
        }



        function confirmCheckout() {
            var isEarly = confirm("Are you sure you want to check out?");
            if (isEarly) {
                getLocationAndSubmit('checkout', 'attendance-form', function(success) {
                    if (success) {
                        stopCountdown();
                        
                        //document.getElementById('checkin-button').style.display = 'block';
                        //document.getElementById('break-buttons').style.display = 'none';
                        //document.getElementById('break-hours').style.display = 'none';
                    }
                });
            }
        }
    
        function handleBreak(type) {
            const teaBreakButton = document.getElementById('tea-break-button');
            const lunchBreakButton = document.getElementById('lunch-break-button');
            const checkoutButton = document.getElementById('checkout-button');
        
            if (breakStart) {
                breakSeconds += Math.floor((Date.now() - breakStart) / 1000);
                breakStart = null;
                updateBreakTime();
        
                if (type === 'tea') {
                    teaBreakButton.innerHTML = '<ion-icon name="cafe-outline" class="align-left"></ion-icon><span class="bold">Tea Break</span>';
                } else if (type === 'lunch') {
                    lunchBreakButton.innerHTML = '<ion-icon name="restaurant-outline" class="align-left"></ion-icon><span class="bold">Lunch Break</span>';
                }
        
                teaBreakButton.disabled = false;
                lunchBreakButton.disabled = false;
                checkoutButton.disabled = false;
                breakActive = false;
                currentBreakType = null;
            } else {
                breakStart = Date.now();
                if (type === 'tea') {
                    teaBreakButton.innerHTML = '<ion-icon name="cafe-outline" class="align-left"></ion-icon><span class="bold">End Tea Break</span>';
                    lunchBreakButton.disabled = true;
                } else if (type === 'lunch') {
                    lunchBreakButton.innerHTML = '<ion-icon name="restaurant-outline" class="align-left"></ion-icon><span class="bold">End Lunch Break</span>';
                    teaBreakButton.disabled = true;
                }
                checkoutButton.disabled = true;
                breakActive = true;
                currentBreakType = type;
            }
        
            localStorage.setItem('breakSeconds', breakSeconds);
            localStorage.setItem('breakStart', breakStart);
            localStorage.setItem('breakActive', breakActive);
            localStorage.setItem('currentBreakType', currentBreakType);
        
            
        }
        
        function updateBreakTime() {
            let hours = Math.floor(breakSeconds / 3600);
            let minutes = Math.floor((breakSeconds % 3600) / 60);
            let seconds = breakSeconds % 60;
            document.getElementById('break-time').textContent = 
                String(hours).padStart(2, '0') + ':' + 
                String(minutes).padStart(2, '0') + ':' + 
                String(seconds).padStart(2, '0');
        }
        
        function resumeCountdown() {
            let storedSeconds = localStorage.getItem('totalSeconds');
            let startTime = localStorage.getItem('startTime');
            breakSeconds = parseInt(localStorage.getItem('breakSeconds')) || 0;
            breakStart = parseInt(localStorage.getItem('breakStart')) || null;
            breakActive = localStorage.getItem('breakActive') === 'true';
            currentBreakType = localStorage.getItem('currentBreakType');
        
            if (storedSeconds && startTime) {
                let elapsed = Math.floor((Date.now() - startTime) / 1000);
                totalSeconds = storedSeconds - elapsed;
        
                if (totalSeconds > 0) {
                    startCountdown();
                    showCheckoutAndBreakButtons();
                    //document.getElementById('checkin-button').style.display = 'none';
                    //document.getElementById('break-buttons').style.display = 'flex';
                    //document.getElementById('break-hours').style.display = 'block';
                } else {
                    stopCountdown();
                }
            }
        
            const teaBreakButton = document.getElementById('tea-break-button');
            const lunchBreakButton = document.getElementById('lunch-break-button');
            const checkoutButton = document.getElementById('checkout-button');
        
            if (breakActive) {
                if (currentBreakType === 'tea') {
                    teaBreakButton.innerHTML = '<ion-icon name="cafe-outline" class="align-left"></ion-icon><span class="bold">End Tea Break</span>';
                    lunchBreakButton.disabled = true;
                } else if (currentBreakType === 'lunch') {
                    lunchBreakButton.innerHTML = '<ion-icon name="restaurant-outline" class="align-left"></ion-icon><span class="bold">End Lunch Break</span>';
                    teaBreakButton.disabled = true;
                }
                checkoutButton.disabled = true;
            }
            updateBreakTime();
        }
        
        function saveCountdownState() {
            localStorage.setItem('totalSeconds', totalSeconds);
            localStorage.setItem('startTime', Date.now());
            localStorage.setItem('breakSeconds', breakSeconds);
            localStorage.setItem('breakStart', breakStart);
            localStorage.setItem('breakActive', breakActive);
            localStorage.setItem('currentBreakType', currentBreakType);
        }
    </script>
    
    <script>
        function updateDateTime() {
            const dateElement = document.getElementById('current-date');
            const timeElement = document.getElementById('current-time');
            const hiddenDateElement = document.getElementById('hidden-date');
            const hiddenDateElementForgot = document.getElementById('forgot-hidden-date');
    
            const now = new Date();
    
            // Format date as 'DD MMM YYYY'
            const options = { year: 'numeric', month: 'short', day: '2-digit' };
            const currentDate = now.toLocaleDateString('en-US', options);
    
            // Format time as 'HH:MM AM/PM'
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
            const currentTime = now.toLocaleTimeString('en-US', timeOptions);
    
            // Combine date and time for hidden input
            const dateTimeOptions = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            const currentDateTime = now.toLocaleString('en-US', dateTimeOptions);

            // Combine date and time for hidden input
            const forgotdateTimeOptions = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            const forgotcurrentDateTime = now.toLocaleString('en-US', forgotdateTimeOptions);
    
            dateElement.textContent = currentDate;
            timeElement.textContent = currentTime;
            hiddenDateElement.value = currentDateTime;
            hiddenDateElementForgot.value = forgotcurrentDateTime;
        }
    
        // Update the date and time when the page loads
        window.onload = updateDateTime;
    
        // Optionally, update the time every minute
        setInterval(updateDateTime, 60000);
    </script>

    
    
    
</body>

</html>